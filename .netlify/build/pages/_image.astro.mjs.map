{"version":3,"file":"_image.astro.mjs","sources":["../../../node_modules/astro/dist/assets/utils/etag.js","../../../node_modules/astro/dist/assets/endpoint/generic.js"],"sourcesContent":["const fnv1a52 = (str) => {\n  const len = str.length;\n  let i = 0, t0 = 0, v0 = 8997, t1 = 0, v1 = 33826, t2 = 0, v2 = 40164, t3 = 0, v3 = 52210;\n  while (i < len) {\n    v0 ^= str.charCodeAt(i++);\n    t0 = v0 * 435;\n    t1 = v1 * 435;\n    t2 = v2 * 435;\n    t3 = v3 * 435;\n    t2 += v0 << 8;\n    t3 += v1 << 8;\n    t1 += t0 >>> 16;\n    v0 = t0 & 65535;\n    t2 += t1 >>> 16;\n    v1 = t1 & 65535;\n    v3 = t3 + (t2 >>> 16) & 65535;\n    v2 = t2 & 65535;\n  }\n  return (v3 & 15) * 281474976710656 + v2 * 4294967296 + v1 * 65536 + (v0 ^ v3 >> 4);\n};\nconst etag = (payload, weak = false) => {\n  const prefix = weak ? 'W/\"' : '\"';\n  return prefix + fnv1a52(payload).toString(36) + payload.length.toString(36) + '\"';\n};\nexport {\n  etag\n};\n","import { imageConfig } from \"astro:assets\";\nimport { isRemotePath } from \"@astrojs/internal-helpers/path\";\nimport { isRemoteAllowed } from \"@astrojs/internal-helpers/remote\";\nimport * as mime from \"mrmime\";\nimport { getConfiguredImageService } from \"../internal.js\";\nimport { etag } from \"../utils/etag.js\";\nasync function loadRemoteImage(src, headers) {\n  try {\n    const res = await fetch(src, {\n      // Forward all headers from the original request\n      headers\n    });\n    if (!res.ok) {\n      return void 0;\n    }\n    return await res.arrayBuffer();\n  } catch {\n    return void 0;\n  }\n}\nconst GET = async ({ request }) => {\n  try {\n    const imageService = await getConfiguredImageService();\n    if (!(\"transform\" in imageService)) {\n      throw new Error(\"Configured image service is not a local service\");\n    }\n    const url = new URL(request.url);\n    const transform = await imageService.parseURL(url, imageConfig);\n    if (!transform?.src) {\n      throw new Error(\"Incorrect transform returned by `parseURL`\");\n    }\n    let inputBuffer = void 0;\n    const isRemoteImage = isRemotePath(transform.src);\n    const sourceUrl = isRemoteImage ? new URL(transform.src) : new URL(transform.src, url.origin);\n    if (isRemoteImage && isRemoteAllowed(transform.src, imageConfig) === false) {\n      return new Response(\"Forbidden\", { status: 403 });\n    }\n    inputBuffer = await loadRemoteImage(sourceUrl, isRemoteImage ? new Headers() : request.headers);\n    if (!inputBuffer) {\n      return new Response(\"Not Found\", { status: 404 });\n    }\n    const { data, format } = await imageService.transform(\n      new Uint8Array(inputBuffer),\n      transform,\n      imageConfig\n    );\n    return new Response(data, {\n      status: 200,\n      headers: {\n        \"Content-Type\": mime.lookup(format) ?? `image/${format}`,\n        \"Cache-Control\": \"public, max-age=31536000\",\n        ETag: etag(data.toString()),\n        Date: (/* @__PURE__ */ new Date()).toUTCString()\n      }\n    });\n  } catch (err) {\n    console.error(\"Could not process image request:\", err);\n    return new Response(`Server Error: ${err}`, { status: 500 });\n  }\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":"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","x_google_ignoreList":[0,1]}